<div class="slide" id="slide5">
    <h2>Challenges and Improvements</h2>

    <!-- Challenge 1 -->
    <div class="challenge">
        <div class="logo-container">
            <img src="assets/images/nexul_academy_icon_logo_300dpi-circle.png" alt="Nexul Academy Logo" class="logo-bg-img">
        </div>

        <h3>Challenge 1 - Issues with Correctly Creating and Editing Checklist Items</h3>
        <!-- <p><b>Problem:</b>
            When implementing the checklist dialog, there were issues with handling multiple checklist items
            using <code>FormArray</code>. Initially, <code class="clickable-code" (click)="showTooltip($event, 'codeTooltip')">[formGroup]="getFormGroup(i)"</code> was used to dynamically bind each
            checklist item form in a loop. However, this approach caused performance issue because Angular needed to call the getFormGroup(i)
            method for each item in the loop, resulting in inefficient change detection.
        </p> -->
        <p><b>Problem:</b>
            When creating or editing items in the checklist dialog, 
            data was not being saved correctly or reflected in the form. 
        </p>
        <!-- <div id="codeTooltip" class="tooltip">
            <pre class="tooltip-code"><code>
// Before
<span class="function">getFormGroup</span>(<span class="variable">index: number</span>): <span class="keyword">FormGroup</span> &#123;
    <span class="keyword2">return</span> <span class="variable">this.items</span>.at(<span class="variable">index</span>) <span class="keyword2">as</span> <span class="keyword">FormGroup</span>;
&#125;
</code></pre>
        </div> -->

        <p><b>Cause:</b> 
            The add and delete operations of checklist items using <code class="highlight-code">FormArray</code> were not properly handled, 
            leading to issues with item validation and data synchronization.
        </p>
        <!-- <p><b>Solution:</b> 
            Changed to directly use the variable defined within the ngFor loop as the formGroup, <code class="clickable-code" (click)="showTooltip($event, 'codeTooltip2')">[formGroup]="itemControl"</code>. 
            This change ensured that each form control was individually bound, 
            optimizing Angular's change detection and improving overall performance.
            Additionally, replaced <code>placeholder</code> with <code>mat-label</code> to maintain UI consistency and added <code>mat-error</code> and <code>mat-hint</code> to 
            guide the user on what to enter.
        </p> -->
        <p><b>Solution:</b> 
            Improved the <code class="highlight-code">patchFormWithChecklist()</code> method to correctly initialize and patch form data.
            Added logic to dynamically update form state when items are added or deleted.
        </p>
        <br>
        <!-- <div id="codeTooltip2" class="tooltip">
            <pre class="tooltip-code"><code>
// After
<span class="function">asFormGroup</span>(<span class="variable">control</span> <span class="keyword">AbstractControl</span>): <span class="keyword">FormGroup</span> &#123;
    <span class="keyword2">return</span> <span class="variable">control</span> <span class="keyword2">as</span> <span class="keyword">FormGroup</span>;
&#125;
</code></pre>
        </div> -->

        <div class="code-wrapper">
            <div class="language-name">typescript</div>
            <pre><code [highlight]="codeSnippet1">
            </code></pre>
        </div>
    </div>

    <!-- Challenge 2 -->
    <div class="challenge">
        <div class="logo-container">
            <img src="assets/images/nexul_academy_icon_logo_300dpi-circle.png" alt="Nexul Academy Logo" class="logo-bg-img">
        </div>

        <h3>Challenge 2 - ID Generation and Data Synchronization Issues</h3>
        <p><b>Problem:</b>
            When adding and editing checklist items, the IDs needed to be consistently generated and synchronized between the 
            frontend and backend. Initially, temporary ID's like 'new' were used, but issues arose when these were not properly replaced with real 
            IDs generated by the backend, causing data inconsistencies.
        </p>
        <p><b>Solution:</b> 
            To solve these issues, several improvements were made across both the backend and frontend:
        </p>
        <ol>
            <li><b>Proper ID Generation and Synchronization Logic:</b>
                <ul>
                    <li>The backend was adjusted to ensure that any checklist item sent with the ID of <code>'new'</code> or null was correctly handled. 
                        The generated unique ID was then explicitly sent back to the frontend, which had to update its model state immediately.</li>
                        <br>
                        <div class="code-section">
                            <h4>Backend Code Changes:</h4>
                            <pre><code>
        // ChecklistController.cs - Revised InsertChecklistAsync Method
        public async Task&lt;ChecklistEditViewModel&gt; InsertChecklistAsync(ChecklistEditViewModel model) &#123;
                foreach (var item in model.Items) &#123;
                    // Only generate a new ID if it is 'new' or empty
                    if (string.IsNullOrEmpty(item.ChecklistItemId) || item.ChecklistItemId == "new") &#123;
                        item.ChecklistItemId = await _idGenerator.NextIdAsync(nameof(ChecklistItem));
                    &#125;
                    // Save the item to the database
                    await _azureChecklistData.InsertAsync(item);
                &#125;
                // Ensure to return the entire model with generated IDs back to the frontend
                return model;
        &#125;</code></pre>
                        </div>
                        <br>
                        <li><b>Ensure All IDs are Properly Returned:</b>
                        After saving each checklist item, the model is returned with the updated IDs, insuring that the frontend has the most accurate data.</li>
                </ul>
            </li>
            <br>
            <li><b>Frontend Adjustments for Accurate Data Handling:</b>
                <ul>
                <li>The frontend had to handle the new IDs returned from the backend correctly. Instead of keeping a static <code>'new'</code> placeholder, 
                    the logic was implemented to patch the form with the newly generated ID immediately.</li>
                    <br>
                    <div class="code-section">
                        <h4>Frontend Code Changes:</h4>
                        <pre><code>
        // checklist-dialog.component.ts
        saveChecklist() &#123;
            this.checklistService.saveChecklist(this.checklistForm.value).subscribe((response: ChecklistEditViewModel) => &#123;
                // Patch the form with the updated checklist items that include new IDs from the backend
                this.checklistForm.patchValue(response);
                this.updateChecklistItems(response.items);
            &#125;, error => &#123;
                console.error('Failed to save checklist:', error);
            &#125;);
        &#125;
        
        updateChecklistItems(items: ChecklistItemEdit[]) &#123;
            // Update local formArray with returned items from the backend, ensuring all IDs are correct
            this.items.clear();
            items.forEach(item => &#123;
                this.items.push(this.createChecklistItemFormGroup(item));
            &#125;);
        &#125;</code></pre>
                    </div>
                    <br>
                    <li><b>Use patchValue and Update Methods: </b>
                        The <code>patchValue()</code> method ensures that any missing IDs are filled in with what the backend has generated. 
                        The <code>updateChecklistItems()</code> method clears the current form controls and repopulates them with the updated data.            </ul>
            </li>
            <br>
            <li><b>Efficient Data Binding and Change Detection in Angular:</b>

            </li>
        </ol>

    
    </div>

    <!-- Challenge 3 -->
    <div class="challenge">
        <div class="logo-container">
            <img src="assets/images/nexul_academy_icon_logo_300dpi-circle.png" alt="Nexul Academy Logo" class="logo-bg-img">
        </div>

        <h3>Challenge 3: Azure Table Storage Index Design and Query Performance</h3>
        <p>
            The initial index design for Azure Table Storage was inefficient, leading to poor query performance and slow data retrieval.
        </p>
        <p><b>Solution:</b> Redesigned the primary key and secondary index for the <code>Checklist</code> table, and removed unnecessary indexes for the <code>ChecklistItem</code> table.
        </p>
        
        <!-- Before and After Code -->
        <div class="code-section">
            <h4>Before:</h4>
            <pre><code>ChecklistTableProxy = new CloudTableProxy&lt;Checklist&gt;()
    &#123;
    TableName = nameof(Checklist),
    PartitionKey = (x) =&gt; ByLessonIndexKey,
    RowKey = (x) =&gt; x.ChecklistId.GetSimpleRowKey(),
    SecondaryIndexes = new List&lt;SecondaryIndex&lt;Checklist&gt;&gt;(new SecondaryIndex&lt;Checklist&gt;[]
    &#123;
        new SecondaryIndex&lt;Checklist&gt;
        &#123;
            KeyName = ByLessonIndexKey,
            PartitionKey = (x) =&gt; x.LessonId.GetSimplePartitionKey(),
            RowKey = (x) =&gt; x.ChecklistId.GetSimpleRowKey(),
            &#125;
    &#125;)
    &#125;;
            </code></pre>

            <h4>After:</h4>
            <pre><code>private const string PKByIdKey = "all-by-id";

    ChecklistTableProxy = new CloudTableProxy&lt;Checklist&gt;()
    &#123;
    TableName = nameof(Checklist),
    PartitionKey = (x) =&gt; PKByIdKey,
    RowKey = (x) =&gt; x.ChecklistId.GetSimpleRowKey(),
    SecondaryIndexes = new List&lt;SecondaryIndex&lt;Checklist&gt;&gt;(new SecondaryIndex&lt;Checklist&gt;[]
    &#123;
        new SecondaryIndex&lt;Checklist&gt;
        &#123;
            KeyName = ByLessonIndexKey,
            PartitionKey = (x) =&gt; x.LessonId.GetSimplePartitionKey(),
            RowKey = (x) =&gt; x.ChecklistId.GetSimpleRowKey(),
        &#125;
    &#125;)
    &#125;;
            </code></pre>
        </div>
    </div>

    <div class="arrow-container">
        <a href="#slide6" class="down-arrow" (click)="smoothScroll('#slide6')">&#x25BC;</a>
    </div>
</div>
